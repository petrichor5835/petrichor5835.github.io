<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>记录一次智慧珞珈场馆预约的折腾</title>
    <link href="/2024/11/05/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%99%BA%E6%85%A7%E7%8F%9E%E7%8F%88%E5%9C%BA%E9%A6%86%E9%A2%84%E7%BA%A6%E7%9A%84%E6%8A%98%E8%85%BE/"/>
    <url>/2024/11/05/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%99%BA%E6%85%A7%E7%8F%9E%E7%8F%88%E5%9C%BA%E9%A6%86%E9%A2%84%E7%BA%A6%E7%9A%84%E6%8A%98%E8%85%BE/</url>
    
    <content type="html"><![CDATA[<h1>背景</h1><p>武汉某大学的羽毛球场馆太火爆了，每晚六点预约，基本秒空，我是真的抢不到，于是想写个脚本去抢。</p><h1>思路</h1><p>一开始有两个思路，一是正向通过selenium库模拟浏览器的行为，二是逆向抓包分析请求。</p><h1>选择</h1><p>第一个思路明显简单很多，但当我在pc上打开信息门户，发现竟然没有场馆预约这个应用，难道只有app端才有？那只能抓包分析请求了，但是非常棘手的点在于，点开预约有个滑块验证码，只有过了这个验证码才能拿到token，拿到token才能发送订单的请求，但是我抓包咋过验证码…我天真的以为验证码图片的包里有对应缺口的坐标，找了半天发现并没有。就这第一步就卡住了，还有其他参数的逆向，想想就觉得太复杂了，想放弃了。</p><p>偶然我拿起手机，在safari搜索信息门户，打开找了一下发现有场馆预约，我把url复制下来，在电脑浏览器打开，竟然能打开，而且和手机端是一样的！这不就成了吗哈哈哈哈哈。在电脑端url后面加上/mobile/homepage就到手机端的页面了。</p><h1>实现</h1><h2 id="在windows上实现">在windows上实现</h2><blockquote><p>先不说别的，首先要让程序能够正常跑起来，至少要在我的电脑上跑起来。</p></blockquote><h3 id="依赖">依赖</h3><p>先导入相关的依赖。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> path<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> findgap <span class="hljs-keyword">import</span> GetDistance<br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver.chrome.service <span class="hljs-keyword">import</span> Service<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> selenium.webdriver.common.action_chains <span class="hljs-keyword">import</span> ActionChains<br><span class="hljs-keyword">from</span> selenium.common.exceptions <span class="hljs-keyword">import</span> (<br>    TimeoutException,<br>    NoSuchElementException,<br>    WebDriverException,<br>)<br></code></pre></td></tr></table></figure><h3 id="日志">日志</h3><p>先在开头定义一下日志，这样才能在每一步看到输出，方便知道代码执行到哪了，从而定位错误。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#初始化日志</span><br>logger = logging.getLogger()<br>logger.setLevel(logging.INFO)<br>console_handler = logging.StreamHandler()<br>console_handler.setLevel(logging.INFO)<br>formatter = logging.Formatter(<br>    <span class="hljs-string">&quot;[%(asctime)s %(levelname)s] %(message)s&quot;</span>, datefmt=<span class="hljs-string">&quot;%H:%M:%S&quot;</span><br>)<br><br>console_handler.setFormatter(formatter)<br>logger.addHandler(console_handler)<br><br></code></pre></td></tr></table></figure><h3 id="全局变量">全局变量</h3><p>定义一下代码要用的全局变量，后面要修改的时候只需要修改变量的值就好。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs py">USERNAME = <span class="hljs-string">&quot;用户名&quot;</span><br>PASSWORD = <span class="hljs-string">&quot;密码&quot;</span><br><span class="hljs-comment">#是否选择后一天(也就是预约下一天)</span><br>NEXTDAY = <span class="hljs-number">1</span><br><span class="hljs-comment">#场地号</span><br>COURT_NUM = <span class="hljs-number">6</span><br><span class="hljs-comment">#球类</span><br>TPYE_ID = <span class="hljs-number">21</span><br>TYPE_MAP = &#123;<br>    <span class="hljs-number">21</span>: <span class="hljs-string">&quot;羽毛球&quot;</span>,<br>    <span class="hljs-number">22</span>: <span class="hljs-string">&quot;乒乓球&quot;</span><br>&#125;<br><span class="hljs-comment">#时间段</span><br>PERIOD = [<span class="hljs-number">10</span>]<br>PERIOD_MAP =&#123;<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&quot;8:00-9:00&quot;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&quot;9:00-10:00&quot;</span>,<br>    <span class="hljs-number">3</span>: <span class="hljs-string">&quot;10:00-11:00&quot;</span>,<br>    <span class="hljs-number">4</span>: <span class="hljs-string">&quot;11:00-12:00&quot;</span>,<br>    <span class="hljs-number">5</span>: <span class="hljs-string">&quot;12:00-13:00&quot;</span>,<br>    <span class="hljs-number">6</span>: <span class="hljs-string">&quot;13:00-14:00&quot;</span>,<br>    <span class="hljs-number">7</span>: <span class="hljs-string">&quot;14:00-15:00&quot;</span>,<br>    <span class="hljs-number">8</span>: <span class="hljs-string">&quot;15:00-16:00&quot;</span>,<br>    <span class="hljs-number">9</span>: <span class="hljs-string">&quot;16:00-17:00&quot;</span>,<br>    <span class="hljs-number">10</span>: <span class="hljs-string">&quot;17:00-18:00&quot;</span>,<br>    <span class="hljs-number">11</span>: <span class="hljs-string">&quot;18:00-19:00&quot;</span>,<br>    <span class="hljs-number">12</span>: <span class="hljs-string">&quot;19:00-20:00&quot;</span>,<br>    <span class="hljs-number">13</span>: <span class="hljs-string">&quot;20:00-21:00&quot;</span><br>&#125;<br><br>HOME_URL = <span class="hljs-string">&quot;https://zhlj.whu.edu.cn/mobile/homepage&quot;</span><br>LOGIN_URL = <span class="hljs-string">&quot;https://cas.whu.edu.cn/authserver/login?service=https://zhlj.whu.edu.cn/mobile/person/caslogin?b=/homepage&quot;</span><br><span class="hljs-comment">#typeId=21 为羽毛球 22为乒乓球</span><br>APPOINTMENT_URL = <span class="hljs-string">f&quot;https://gym.whu.edu.cn/hsdsqhafive/pages/index/reserve?typeId=<span class="hljs-subst">&#123;TPYE_ID&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><h3 id="主要类">主要类</h3><p>定义一下实现这个程序的类，然后在类中定义相关方法。</p><h4 id="初始化">初始化</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">global</span> chrome_options<br>chrome_options = webdriver.ChromeOptions()<br>chrome_options.add_argument(<span class="hljs-string">&quot;--no-sandbox&quot;</span>)<br>chrome_options.add_argument(<span class="hljs-string">&quot;--disable-gpu&quot;</span>)<br>chrome_options.add_argument(<span class="hljs-string">&quot;--disable-dev-shm-usage&quot;</span>)<br><span class="hljs-variable language_">self</span>.driver = <span class="hljs-literal">None</span><br></code></pre></td></tr></table></figure><h4 id="登陆类">登陆类</h4><p>方法很简单，通过xpath定位元素，然后点击就行了。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>    <span class="hljs-keyword">try</span>:<br>        logging.info(<span class="hljs-string">f&quot;--- 开始尝试登录：<span class="hljs-subst">&#123;USERNAME&#125;</span>---&quot;</span>)<br><br>        username_field = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>            EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/div[1]/input&#x27;</span>))<br>        )<br>        <span class="hljs-comment"># self.simulate_typing(username_field, self.username)</span><br>        username_field.send_keys(USERNAME)<br>        password_field = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>            EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/div[2]/input[1]&#x27;</span>))<br>        )<br>        <span class="hljs-comment"># self.simulate_typing(password_field, self.password)</span><br>        password_field.send_keys(PASSWORD)<br>        submit_button = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>            EC.element_to_be_clickable((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/p[2]/button&#x27;</span>))<br>        )<br>        submit_button.click()<br><br>        WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">10</span>).until(<br>            EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;swiper-apply&quot;]/h3/span[3]&#x27;</span>))<br>        )<br>        logging.info(<span class="hljs-string">&quot;登录成功&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logging.error(<span class="hljs-string">f&quot;登录失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>  <br></code></pre></td></tr></table></figure><h4 id="预约类">预约类</h4><p>登陆之后，新开一个页面就保留相关cookie了，所以无需验证了，直接导航到预约页面，再根据需求点击点击就好啦，实在是太简单啦。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">appointment</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>    <span class="hljs-keyword">try</span>:<br>        logging.info(<span class="hljs-string">f&quot;--- 开始尝试预约 ---&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.driver.execute_script(<span class="hljs-string">&quot;window.open(&#x27;&#x27;);&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.driver.switch_to.window(<span class="hljs-variable language_">self</span>.driver.window_handles[-<span class="hljs-number">1</span>])<br>        logging.info(<span class="hljs-string">&quot;导航到预约页面&quot;</span>)<br>        <span class="hljs-variable language_">self</span>.driver.get(APPOINTMENT_URL)<br>        time.sleep(<span class="hljs-number">0.5</span>)<br>        <span class="hljs-comment">#判断是否到18点，如果没到就每隔0.5s刷新一次直到18点</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            now = time.localtime(time.time())<br>            <span class="hljs-keyword">if</span> now.tm_hour == <span class="hljs-number">18</span>:<br>                <span class="hljs-keyword">break</span><br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-variable language_">self</span>.driver.refresh()<br>        <span class="hljs-comment"># 点击后一天</span><br>        <span class="hljs-keyword">if</span> NEXTDAY:<br>            <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[1]/uni-view[3]&#x27;</span>).click()<br>        <span class="hljs-keyword">try</span>:<br><br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            logging.info(<span class="hljs-string">&quot;开始选择场地&quot;</span>)<br><br>            <span class="hljs-comment"># 选择松园体育馆</span><br>            <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[2]/uni-view[2]/uni-view/uni-view[1]&#x27;</span>).click()<br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-comment"># 选择场地</span><br>            <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">f&#x27;//*[@class=&quot;uni-collapse-item__wrap is--transition&quot;]/uni-view/uni-view/uni-view[<span class="hljs-subst">&#123;COURT_NUM+<span class="hljs-number">1</span>&#125;</span>]/uni-view[5]/uni-text/span&#x27;</span>).click()<br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-comment"># 选择时间段</span><br>            <span class="hljs-keyword">for</span> PERIOD <span class="hljs-keyword">in</span> PERIOD:<br>                <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">f&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[2]/uni-view[3]/uni-view[<span class="hljs-subst">&#123;PERIOD&#125;</span>]&#x27;</span>).click()<br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-comment"># 点击预约</span><br>            <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[3]/uni-view[2]/uni-view[3]&#x27;</span>).click()<br><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;操作失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="打码">打码</h4><p>我也以为很简单，但是，还是逃不过验证码啊，万恶的验证码。</p><img src="/2024/11/05/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%99%BA%E6%85%A7%E7%8F%9E%E7%8F%88%E5%9C%BA%E9%A6%86%E9%A2%84%E7%BA%A6%E7%9A%84%E6%8A%98%E8%85%BE/verify.png" class="" title="验证码"><p>过这滑块验证有两个思路,一个是本地写一个脚本，通过opencv算出滑块要移动的距离，或者调用第三方打码平台的接口，直接返回距离。</p><p>我找到了csdn “<a href="https://blog.csdn.net/qq_44419449">骑着青蛙一起二</a>”大佬写的脚本，用了一下发现计算效果非常不错，感谢这位大佬，原帖：<a href="https://blog.csdn.net/qq_44419449/article/details/127414044">https://blog.csdn.net/qq_44419449/article/details/127414044</a></p><p>我修改了一下，脚本如下(<a href="http://findgap.py">findgap.py</a>)</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> cv2<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handel_img</span>(<span class="hljs-params">img</span>):<br>    imgGray = cv2.cvtColor(img, cv2.COLOR_RGBA2GRAY)  <span class="hljs-comment"># 转灰度图</span><br>    imgBlur = cv2.GaussianBlur(imgGray, (<span class="hljs-number">5</span>, <span class="hljs-number">5</span>), <span class="hljs-number">1</span>)  <span class="hljs-comment"># 高斯模糊</span><br>    imgCanny = cv2.Canny(imgBlur, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>)  <span class="hljs-comment"># Canny算子边缘检测</span><br>    <span class="hljs-keyword">return</span> imgCanny<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">match</span>(<span class="hljs-params">img_jpg_path, img_png_path</span>):<br>    <span class="hljs-comment"># 读取图像</span><br>    img_jpg = cv2.imread(img_jpg_path, cv2.IMREAD_UNCHANGED)<br>    img_png = cv2.imread(img_png_path, cv2.IMREAD_UNCHANGED)<br>    img = handel_img(img_jpg)<br>    small_img = handel_img(img_png)<br>    res_TM_CCOEFF_NORMED = cv2.matchTemplate(img, small_img, <span class="hljs-number">3</span>)<br>    value = cv2.minMaxLoc(res_TM_CCOEFF_NORMED)<br>    value = value[<span class="hljs-number">3</span>][<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取到移动距离</span><br>    <span class="hljs-keyword">return</span> value<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetDistance</span>(<span class="hljs-params">background_path,gap_path</span>):<br>    distance = <span class="hljs-keyword">match</span>(background_path, gap_path)<br>    distance = distance /<span class="hljs-number">480</span> * <span class="hljs-number">345</span> + <span class="hljs-number">12</span> -<span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> distance<br><br></code></pre></td></tr></table></figure><p>主程序中调用该程序中的GetDistance函数即可</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs py">canvas_data_url = <span class="hljs-variable language_">self</span>.driver.execute_script(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">var canvas = document.querySelector(&#x27;canvas&#x27;);  // 定位到 canvas 元素</span><br><span class="hljs-string">return canvas.toDataURL(&#x27;image/png&#x27;);  // 将 canvas 内容转换为 PNG 格式的 data URL</span><br><span class="hljs-string">&quot;&quot;&quot;</span>)<br>canvas_base64 = canvas_data_url.split(<span class="hljs-string">&#x27;,&#x27;</span>)[<span class="hljs-number">1</span>]<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;background.png&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(base64.b64decode(canvas_base64))<br>logging.info(<span class="hljs-string">&quot;获取背景图片成功&quot;</span>)<br>gap = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_sub-slider_1&quot;]/img&#x27;</span>)<br>gap_url = gap.get_attribute(<span class="hljs-string">&quot;src&quot;</span>)<br>gap_img = Image.<span class="hljs-built_in">open</span>(BytesIO(requests.get(gap_url).content))<br>gap_img.save(<span class="hljs-string">&quot;gap.png&quot;</span>)<br>logging.info(<span class="hljs-string">&quot;获取缺口图片成功&quot;</span>)<br><br><span class="hljs-comment">#调用opencv计算距离</span><br>distance = GetDistance(<span class="hljs-string">&quot;background.png&quot;</span>, <span class="hljs-string">&quot;gap.png&quot;</span>)<br>logging.info(<span class="hljs-string">f&quot;计算距离为<span class="hljs-subst">&#123;distance&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#模拟滑动(多次)</span><br>slider = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_slider_1&quot;]&#x27;</span>)<br>action = ActionChains(<span class="hljs-variable language_">self</span>.driver)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    action.click_and_hold(slider).move_by_offset(xoffset=distance+<span class="hljs-number">2</span>*i-<span class="hljs-number">4</span>, yoffset=<span class="hljs-number">0</span>).release().perform()<br>    time.sleep(<span class="hljs-number">0.5</span>)<br>    <span class="hljs-keyword">try</span>:<br>        canvas = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_bg_1&quot;]/canvas&#x27;</span>)<br>    <span class="hljs-keyword">except</span> Exception:<br>        logging.info(<span class="hljs-string">&quot;验证成功&quot;</span>)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">4</span>:<br>        logging.error(<span class="hljs-string">&quot;验证失败&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>logging.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;TYPE_MAP[TPYE_ID]&#125;</span>预约成功, 场地号：<span class="hljs-subst">&#123;COURT_NUM&#125;</span>, 时间段：<span class="hljs-subst">&#123;PERIOD_MAP[PERIOD]&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><h4 id="完整程序">完整程序</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> os <span class="hljs-keyword">import</span> path<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-keyword">from</span> findgap <span class="hljs-keyword">import</span> GetDistance<br><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver<br><span class="hljs-keyword">from</span> selenium.webdriver.chrome.service <span class="hljs-keyword">import</span> Service<br><span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By<br><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait<br><span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC<br><span class="hljs-keyword">from</span> selenium.webdriver.common.action_chains <span class="hljs-keyword">import</span> ActionChains<br><span class="hljs-keyword">from</span> selenium.common.exceptions <span class="hljs-keyword">import</span> (<br>    TimeoutException,<br>    NoSuchElementException,<br>    WebDriverException,<br>)<br><br><br><span class="hljs-comment">#初始化日志</span><br>logger = logging.getLogger()<br>logger.setLevel(logging.INFO)<br>console_handler = logging.StreamHandler()<br>console_handler.setLevel(logging.INFO)<br>formatter = logging.Formatter(<br>    <span class="hljs-string">&quot;[%(asctime)s %(levelname)s] %(message)s&quot;</span>, datefmt=<span class="hljs-string">&quot;%H:%M:%S&quot;</span><br>)<br><br>console_handler.setFormatter(formatter)<br>logger.addHandler(console_handler)<br><br>USERNAME = <span class="hljs-string">&quot;用户名&quot;</span><br>PASSWORD = <span class="hljs-string">&quot;密码&quot;</span><br><span class="hljs-comment">#是否选择后一天(也就是预约下一天)</span><br>NEXTDAY = <span class="hljs-number">1</span><br><span class="hljs-comment">#场地号</span><br>COURT_NUM = <span class="hljs-number">6</span><br><span class="hljs-comment">#球类</span><br>TPYE_ID = <span class="hljs-number">21</span><br>TYPE_MAP = &#123;<br>    <span class="hljs-number">21</span>: <span class="hljs-string">&quot;羽毛球&quot;</span>,<br>    <span class="hljs-number">22</span>: <span class="hljs-string">&quot;乒乓球&quot;</span><br>&#125;<br><span class="hljs-comment">#时间段</span><br>PERIOD = [<span class="hljs-number">10</span>]<br>PERIOD_MAP =&#123;<br>    <span class="hljs-number">1</span>: <span class="hljs-string">&quot;8:00-9:00&quot;</span>,<br>    <span class="hljs-number">2</span>: <span class="hljs-string">&quot;9:00-10:00&quot;</span>,<br>    <span class="hljs-number">3</span>: <span class="hljs-string">&quot;10:00-11:00&quot;</span>,<br>    <span class="hljs-number">4</span>: <span class="hljs-string">&quot;11:00-12:00&quot;</span>,<br>    <span class="hljs-number">5</span>: <span class="hljs-string">&quot;12:00-13:00&quot;</span>,<br>    <span class="hljs-number">6</span>: <span class="hljs-string">&quot;13:00-14:00&quot;</span>,<br>    <span class="hljs-number">7</span>: <span class="hljs-string">&quot;14:00-15:00&quot;</span>,<br>    <span class="hljs-number">8</span>: <span class="hljs-string">&quot;15:00-16:00&quot;</span>,<br>    <span class="hljs-number">9</span>: <span class="hljs-string">&quot;16:00-17:00&quot;</span>,<br>    <span class="hljs-number">10</span>: <span class="hljs-string">&quot;17:00-18:00&quot;</span>,<br>    <span class="hljs-number">11</span>: <span class="hljs-string">&quot;18:00-19:00&quot;</span>,<br>    <span class="hljs-number">12</span>: <span class="hljs-string">&quot;19:00-20:00&quot;</span>,<br>    <span class="hljs-number">13</span>: <span class="hljs-string">&quot;20:00-21:00&quot;</span><br>&#125;<br><br>HOME_URL = <span class="hljs-string">&quot;https://zhlj.whu.edu.cn/mobile/homepage&quot;</span><br>LOGIN_URL = <span class="hljs-string">&quot;https://cas.whu.edu.cn/authserver/login?service=https://zhlj.whu.edu.cn/mobile/person/caslogin?b=/homepage&quot;</span><br><span class="hljs-comment">#typeId=21 为羽毛球 22为乒乓球</span><br>APPOINTMENT_URL = <span class="hljs-string">f&quot;https://gym.whu.edu.cn/hsdsqhafive/pages/index/reserve?typeId=<span class="hljs-subst">&#123;TPYE_ID&#125;</span>&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">zhljBrowser</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        logging.info(<span class="hljs-string">&quot;启动 Selenium&quot;</span>)<br><br>        <span class="hljs-keyword">global</span> chrome_options<br>        <span class="hljs-keyword">global</span> chromedriver_path<br><br>        chrome_options = webdriver.ChromeOptions()<br>        <span class="hljs-comment"># chrome_options.add_argument(&quot;--headless&quot;)</span><br>        chrome_options.add_argument(<span class="hljs-string">&quot;--no-sandbox&quot;</span>)<br>        chrome_options.add_argument(<span class="hljs-string">&quot;--disable-gpu&quot;</span>)<br>        chrome_options.add_argument(<span class="hljs-string">&quot;--disable-dev-shm-usage&quot;</span>)<br><br>        <span class="hljs-comment"># chromedriver_path = shutil.which(&quot;chromedriver&quot;)</span><br><br>        <span class="hljs-comment"># if not chromedriver_path:</span><br>        <span class="hljs-comment">#     logging.error(&quot;chromedriver 未找到，请确保已安装并配置正确的路径。&quot;)</span><br>        <span class="hljs-comment">#     exit(1)</span><br>        <span class="hljs-variable language_">self</span>.driver = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">try</span>:<br>            logging.info(<span class="hljs-string">f&quot;--- 开始尝试登录：<span class="hljs-subst">&#123;USERNAME&#125;</span>---&quot;</span>)<br><br>            username_field = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>                EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/div[1]/input&#x27;</span>))<br>            )<br>            <span class="hljs-comment"># self.simulate_typing(username_field, self.username)</span><br>            username_field.send_keys(USERNAME)<br>            password_field = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>                EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/div[2]/input[1]&#x27;</span>))<br>            )<br>            <span class="hljs-comment"># self.simulate_typing(password_field, self.password)</span><br>            password_field.send_keys(PASSWORD)<br>            submit_button = WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">20</span>).until(<br>                EC.element_to_be_clickable((By.XPATH, <span class="hljs-string">&#x27;/html/body/div/div[2]/div[3]/div[2]/div[5]/div[2]/form/p[2]/button&#x27;</span>))<br>            )<br>            submit_button.click()<br><br>            WebDriverWait(<span class="hljs-variable language_">self</span>.driver, <span class="hljs-number">10</span>).until(<br>                EC.presence_of_element_located((By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;swiper-apply&quot;]/h3/span[3]&#x27;</span>))<br>            )<br>            logging.info(<span class="hljs-string">&quot;登录成功&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;登录失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>           <br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">appointment</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">try</span>:<br>            logging.info(<span class="hljs-string">f&quot;--- 开始尝试预约 ---&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.driver.execute_script(<span class="hljs-string">&quot;window.open(&#x27;&#x27;);&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.driver.switch_to.window(<span class="hljs-variable language_">self</span>.driver.window_handles[-<span class="hljs-number">1</span>])<br>            logging.info(<span class="hljs-string">&quot;导航到预约页面&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.driver.get(APPOINTMENT_URL)<br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-comment">#判断是否到18点，如果没到就每隔0.5s刷新一次直到18点</span><br>            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>                now = time.localtime(time.time())<br>                <span class="hljs-keyword">if</span> now.tm_hour == <span class="hljs-number">18</span>:<br>                    <span class="hljs-keyword">break</span><br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-variable language_">self</span>.driver.refresh()<br>            <span class="hljs-comment"># 点击后一天</span><br>            <span class="hljs-keyword">if</span> NEXTDAY:<br>                <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[1]/uni-view[3]&#x27;</span>).click()<br>            <span class="hljs-keyword">try</span>:<br><br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                logging.info(<span class="hljs-string">&quot;开始选择场地&quot;</span>)<br><br>                <span class="hljs-comment"># 选择松园体育馆</span><br>                <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[2]/uni-view[2]/uni-view/uni-view[1]&#x27;</span>).click()<br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-comment"># 选择场地</span><br>                <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">f&#x27;//*[@class=&quot;uni-collapse-item__wrap is--transition&quot;]/uni-view/uni-view/uni-view[<span class="hljs-subst">&#123;COURT_NUM+<span class="hljs-number">1</span>&#125;</span>]/uni-view[5]/uni-text/span&#x27;</span>).click()<br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-comment"># 选择时间段</span><br>                <span class="hljs-keyword">for</span> PERIOD <span class="hljs-keyword">in</span> PERIOD:<br>                    <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">f&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[2]/uni-view[3]/uni-view[<span class="hljs-subst">&#123;PERIOD&#125;</span>]&#x27;</span>).click()<br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-comment"># 点击预约</span><br>                <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;app&quot;]/uni-app/uni-page/uni-page-wrapper/uni-page-body/uni-view/uni-view[1]/uni-view[3]/uni-view[2]/uni-view[3]&#x27;</span>).click()<br><br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                logging.error(<span class="hljs-string">f&quot;操作失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            time.sleep(<span class="hljs-number">0.5</span>)<br>            <span class="hljs-comment">#滑块验证</span><br>            <span class="hljs-comment">#获取背景图片和缺口图片</span><br>            canvas_data_url = <span class="hljs-variable language_">self</span>.driver.execute_script(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            var canvas = document.querySelector(&#x27;canvas&#x27;);  // 定位到 canvas 元素</span><br><span class="hljs-string">            return canvas.toDataURL(&#x27;image/png&#x27;);  // 将 canvas 内容转换为 PNG 格式的 data URL</span><br><span class="hljs-string">        &quot;&quot;&quot;</span>)<br>            canvas_base64 = canvas_data_url.split(<span class="hljs-string">&#x27;,&#x27;</span>)[<span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;background.png&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                f.write(base64.b64decode(canvas_base64))<br>            logging.info(<span class="hljs-string">&quot;获取背景图片成功&quot;</span>)<br>            gap = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_sub-slider_1&quot;]/img&#x27;</span>)<br>            gap_url = gap.get_attribute(<span class="hljs-string">&quot;src&quot;</span>)<br>            gap_img = Image.<span class="hljs-built_in">open</span>(BytesIO(requests.get(gap_url).content))<br>            gap_img.save(<span class="hljs-string">&quot;gap.png&quot;</span>)<br>            logging.info(<span class="hljs-string">&quot;获取缺口图片成功&quot;</span>)<br><br>            <span class="hljs-comment">#调用opencv计算距离</span><br>            distance = GetDistance(<span class="hljs-string">&quot;background.png&quot;</span>, <span class="hljs-string">&quot;gap.png&quot;</span>)<br>            logging.info(<span class="hljs-string">f&quot;计算距离为<span class="hljs-subst">&#123;distance&#125;</span>&quot;</span>)<br><br>            <span class="hljs-comment">#模拟滑动(多次)</span><br>            slider = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_slider_1&quot;]&#x27;</span>)<br>            action = ActionChains(<span class="hljs-variable language_">self</span>.driver)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>                action.click_and_hold(slider).move_by_offset(xoffset=distance+<span class="hljs-number">2</span>*i-<span class="hljs-number">4</span>, yoffset=<span class="hljs-number">0</span>).release().perform()<br>                time.sleep(<span class="hljs-number">0.5</span>)<br>                <span class="hljs-keyword">try</span>:<br>                    canvas = <span class="hljs-variable language_">self</span>.driver.find_element(By.XPATH, <span class="hljs-string">&#x27;//*[@id=&quot;dx_captcha_basic_bg_1&quot;]/canvas&#x27;</span>)<br>                <span class="hljs-keyword">except</span> Exception:<br>                    logging.info(<span class="hljs-string">&quot;验证成功&quot;</span>)<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> i == <span class="hljs-number">4</span>:<br>                    logging.error(<span class="hljs-string">&quot;验证失败&quot;</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>            logging.info(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;TYPE_MAP[TPYE_ID]&#125;</span>预约成功, 场地号：<span class="hljs-subst">&#123;COURT_NUM&#125;</span>, 时间段：<span class="hljs-subst">&#123;PERIOD_MAP[PERIOD]&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;按任意键继续&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>  <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;预约失败：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>    <br>       <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.driver = webdriver.Chrome(options=chrome_options)<br>            <span class="hljs-variable language_">self</span>.driver.get(LOGIN_URL)<br>            <span class="hljs-variable language_">self</span>.login()<br>            <span class="hljs-variable language_">self</span>.appointment()<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logging.error(<span class="hljs-string">f&quot;发生错误：<span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    zhlj_browser = zhljBrowser()<br>    zhlj_browser.run()<br></code></pre></td></tr></table></figure><h3 id="定时任务">定时任务</h3><p>代码写完了，运行了一下没问题，接着在Windows中设置定时任务(任务计划程序)即可。</p><h2 id="部署在云端">部署在云端</h2><blockquote><p>人的欲望是不断膨胀的，为什么预约一定要开着电脑，我想要关掉电脑也能预约。这样我在预约时间段有事也能完成预约了。</p></blockquote><h3 id="初步尝试">初步尝试</h3><p>正好我有一台2核4G的云服务器，Ubuntu操作系统，于是我稍微修改了一下代码以让它可以在Linux操作系统正常运行，我还安装了青龙面板来管理脚本并定时执行脚本。当我点开始运行的时候发现，程序始终过不了登陆，排查之后发现是因为登陆的时候又跳验证码了！</p><h3 id="解决主要问题">解决主要问题</h3><p>为啥我在本地运行的时候，登陆没有跳验证码，而在云服务器上就有验证码？很快我想到了是校园网的原因，在校园网的环境下登陆不需要验证码，而非校园网的环境登陆就有验证码。</p><p>我首先想到的还是打码，但是这个验证码非常之恶心，它的类型不一致，有滑块，选文字，选图形，有选一个坐标的，还有选多个的，最关键的是，每次的类型还是随机的，这意味着本地打码需要非常多的代码，而用打码平台呢，还要先判断验证码的类型，这实现起来太复杂了。</p><p>既然要校园网的环境，那我就搞个代理，让服务器的流量都通过代理访问学校的服务器，这样不就行了。问题在于我没有处在校园网环境的公网服务器，转发不了流量。</p><p>又要作罢了吗，突然想到大一搞过学校的VPN，当时以为是拿来富强用的，但是没用就丢掉了。突然想到这VPN是不是给校外的设备提供的通道，于是去用了一下，发现真行。</p><p>当我下载Ubuntu系统的atrust客户端时，发现怎么都安装不成功，问了一下客服说是要有gui，不能纯命令行，于是我安装了Ubuntu桌面（不是Ubuntu桌面系统），但是启动软件的时候总是显示核心未启动，折腾了好久都不成功。我猜测需要Ubuntu桌面系统才行，但是云服务器没有该镜像，上传自定义镜像还要开通对象存储服务，要100块。</p><blockquote><p>没有办法了，Windows Server，启动！！！</p></blockquote><p>我是真不想用Windows，因为只有4G内存，肯定不流畅。但好在有4G内存，不然Windows都启动不了，开机内存就百分之五十以上了。</p><h3 id="其他问题">其他问题</h3><h4 id="atrust客户端保活">atrust客户端保活</h4><p>在一段时间（具体几个小时没测试过）没有向学校的网站发送请求时，atrust客户端会自动断开连接。所以要有一个脚本定时发送请求，我是用powershell实现的。</p><figure class="highlight ps1"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ps1"><span class="hljs-comment"># PowerShell script to send HTTPS request</span><br><span class="hljs-variable">$url</span> = <span class="hljs-string">&quot;https://www.whu.edu.cn&quot;</span><br><span class="hljs-variable">$response</span> = <span class="hljs-built_in">Invoke-WebRequest</span> <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$url</span> <span class="hljs-literal">-Method</span> Get<br></code></pre></td></tr></table></figure><h4 id="无头模式运行">无头模式运行</h4><p>selenium默认情况下会启动浏览器进行，这就需要有图形界面，但是断开远程桌面就不支持gui了，于是脚本会运行失败（卡在正在启动selenium）。</p><p>需要在chromedriver添加如下参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">chrome_options.add_argument(<span class="hljs-string">&quot;--headless&quot;</span>)<br>chrome_options.add_argument(<span class="hljs-string">&quot;user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;</span>)<br></code></pre></td></tr></table></figure><h3 id="运行结果">运行结果</h3><img src="/2024/11/05/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E6%99%BA%E6%85%A7%E7%8F%9E%E7%8F%88%E5%9C%BA%E9%A6%86%E9%A2%84%E7%BA%A6%E7%9A%84%E6%8A%98%E8%85%BE/result.png" class="" title="运行结果"><h1>吐槽</h1><p>个人认为最优雅的方案是Ubuntu+青龙面板，但是atrust不支持纯命令行，为什么不支持纯命令行啊啊啊啊！</p>]]></content>
    
    
    <categories>
      
      <category>实用脚本</category>
      
    </categories>
    
    
    <tags>
      
      <tag>实用脚本</tag>
      
      <tag>python</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux监控流量并发送到tg</title>
    <link href="/2024/10/10/Linux%E7%9B%91%E6%8E%A7%E6%B5%81%E9%87%8F%E5%B9%B6%E5%8F%91%E9%80%81%E5%88%B0tg/"/>
    <url>/2024/10/10/Linux%E7%9B%91%E6%8E%A7%E6%B5%81%E9%87%8F%E5%B9%B6%E5%8F%91%E9%80%81%E5%88%B0tg/</url>
    
    <content type="html"><![CDATA[<blockquote><p>为了防止自己机子的流量突然跑光，流量监控还是非常有必要的，为了省去每天打开网站去check的烦恼，便有了以下的方法。</p></blockquote><p>为了实现每隔一天向 Telegram 机器人发送当前已用流量的通知，你可以按照以下步骤进行操作：</p><h3 id="步骤-1-安装依赖工具">步骤 1: 安装依赖工具</h3><p>首先，确保你已经安装了以下工具：</p><ol><li><p><strong><code>vnstat</code></strong>：用于监控网络流量。</p><ul><li><p>安装命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install vnstat<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong><code>telegram-send</code></strong>：用于通过 Telegram 发送消息。</p><ul><li><p>可以使用apt安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt install telegram-send<br></code></pre></td></tr></table></figure></li><li><p>也可使用pip，如果没有安装pip和python要先安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt install python3-pip<br></code></pre></td></tr></table></figure></li><li><p>安装命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pip install telegram-send<br></code></pre></td></tr></table></figure></li></ul></li></ol><h3 id="步骤-2-配置-telegram-send">步骤 2: 配置 <code>telegram-send</code></h3><p>你需要使用 <code>telegram-send</code> 配置你的 Telegram 机器人，以便它能够发送消息。</p><ol><li><p>运行以下命令开始配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">telegram-send --configure<br></code></pre></td></tr></table></figure></li><li><p>根据提示，输入token等命令，将 <code>telegram-send</code> 与 Telegram 机器人关联。</p></li></ol><h3 id="步骤-3-创建流量监控脚本">步骤 3: 创建流量监控脚本</h3><p>接下来，编写一个 Bash 脚本，用于每隔一天检查流量并将结果通过 Telegram 发送。</p><ol><li><p>创建脚本文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">nano ~/send_traffic.sh<br></code></pre></td></tr></table></figure></li><li><p>在脚本中输入以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># 网络接口名称 (根据实际接口修改)</span><br>INTERFACE=<span class="hljs-string">&quot;ens5&quot;</span><br><br><span class="hljs-comment"># 获取当天的总流量 (第6列)</span><br>traffic_today=$(vnstat --oneline -i <span class="hljs-variable">$INTERFACE</span> | awk -F<span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-string">&#x27;&#123;print $6&#125;&#x27;</span>)<br><br><span class="hljs-comment"># 获取当月的总流量 (第11列)</span><br>traffic_month=$(vnstat --oneline -i <span class="hljs-variable">$INTERFACE</span> | awk -F<span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-string">&#x27;&#123;print $11&#125;&#x27;</span>)<br><br><span class="hljs-comment"># 调试信息：输出原始流量数据</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;原始当天流量: <span class="hljs-variable">$traffic_today</span>&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;原始当月流量: <span class="hljs-variable">$traffic_month</span>&quot;</span><br><br><span class="hljs-comment"># 检查是否获取到了流量数据</span><br><span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_today</span>&quot;</span> || -z <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_month</span>&quot;</span> ]]; <span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;未获取到流量数据&quot;</span><br>  traffic_today=0<br>  traffic_month=0  <span class="hljs-comment"># 设置默认值</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-comment">#vnstat输出流量不足1GB时单位是MB，超过1GB时单位是GB，所以要根据单位作一个判断</span><br><span class="hljs-comment"># 根据单位处理当天流量的数值</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_today</span>&quot;</span> == *<span class="hljs-string">&quot;MiB&quot;</span>* ]]; <span class="hljs-keyword">then</span><br>  traffic_today_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$traffic_today</span> | sed -E <span class="hljs-string">&#x27;s/([0-9.]+) MiB/\1/&#x27;</span>)<br>  traffic_today_gb=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;scale=2; <span class="hljs-variable">$traffic_today_value</span> / 1024&quot;</span> | bc)  <span class="hljs-comment"># MiB 转换为 GB</span><br>  traffic_today_unit=<span class="hljs-string">&quot;MiB&quot;</span><br><span class="hljs-keyword">elif</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_today</span>&quot;</span> == *<span class="hljs-string">&quot;GiB&quot;</span>* ]]; <span class="hljs-keyword">then</span><br>  traffic_today_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$traffic_today</span> | sed -E <span class="hljs-string">&#x27;s/([0-9.]+) GiB/\1/&#x27;</span>)<br>  traffic_today_gb=<span class="hljs-variable">$traffic_today_value</span>  <span class="hljs-comment"># 如果是 GB，保持原值</span><br>  traffic_today_unit=<span class="hljs-string">&quot;GiB&quot;</span><br><span class="hljs-keyword">else</span><br>  traffic_today_value=0<br>  traffic_today_gb=0<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 根据单位处理当月流量的数值</span><br><span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_month</span>&quot;</span> == *<span class="hljs-string">&quot;MiB&quot;</span>* ]]; <span class="hljs-keyword">then</span><br>  traffic_month_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$traffic_month</span> | sed -E <span class="hljs-string">&#x27;s/([0-9.]+) MiB/\1/&#x27;</span>)<br>  traffic_month_gb=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;scale=2; <span class="hljs-variable">$traffic_month_value</span> / 1024&quot;</span> | bc)  <span class="hljs-comment"># MiB 转换为 GB</span><br>  traffic_month_unit=<span class="hljs-string">&quot;MiB&quot;</span><br><span class="hljs-keyword">elif</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$traffic_month</span>&quot;</span> == *<span class="hljs-string">&quot;GiB&quot;</span>* ]]; <span class="hljs-keyword">then</span><br>  traffic_month_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$traffic_month</span> | sed -E <span class="hljs-string">&#x27;s/([0-9.]+) GiB/\1/&#x27;</span>)<br>  traffic_month_gb=<span class="hljs-variable">$traffic_month_value</span>  <span class="hljs-comment"># 如果是 GB，保持原值</span><br>  traffic_month_unit=<span class="hljs-string">&quot;GiB&quot;</span><br><span class="hljs-keyword">else</span><br>  traffic_month_value=0<br>  traffic_month_gb=0<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 调试信息：输出转换后的流量数值</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;当天流量: <span class="hljs-variable">$traffic_today_value</span> <span class="hljs-variable">$traffic_today_unit</span> (<span class="hljs-variable">$traffic_today_gb</span> GB)&quot;</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;当月流量: <span class="hljs-variable">$traffic_month_value</span> <span class="hljs-variable">$traffic_month_unit</span> (<span class="hljs-variable">$traffic_month_gb</span> GB)&quot;</span><br><br><span class="hljs-comment"># 发送流量信息到 Telegram，带上MB和转换后的GB</span><br>telegram-send <span class="hljs-string">&quot;Claw 的今日已用流量: <span class="hljs-variable">$traffic_today_value</span> <span class="hljs-variable">$traffic_today_unit</span> (<span class="hljs-variable">$traffic_today_gb</span> GB), 本月已用流量: <span class="hljs-variable">$traffic_month_value</span> <span class="hljs-variable">$traffic_month_unit</span> (<span class="hljs-variable">$traffic_month_gb</span> GB)&quot;</span><br><br></code></pre></td></tr></table></figure></li><li><p>保存并退出 (<code>Ctrl + O</code>，然后 <code>Ctrl + X</code>）。</p></li><li><p>赋予脚本可执行权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x ~/send_traffic.sh<br></code></pre></td></tr></table></figure></li></ol><h3 id="步骤-4-设置-cron-定时任务">步骤 4: 设置 <code>cron</code> 定时任务</h3><p>使用 <code>cron</code> 每隔一天自动执行该脚本。</p><ol><li><p>编辑 <code>cron</code> 定时任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab -e<br></code></pre></td></tr></table></figure></li><li><p>添加以下行到 <code>crontab</code> 文件中，设置每隔一天的午夜执行脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">@daily /bin/bash ~/send_traffic.sh<br><span class="hljs-comment">#也可以使用 0 0 * * * /bin/bash ~/send_traffic.sh</span><br></code></pre></td></tr></table></figure><p>这行表示每隔1天的午夜 <code>00:00</code> 执行一次脚本。</p></li><li><p>保存并退出 <code>crontab</code> 编辑器。</p></li></ol><h3 id="TIPS">TIPS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">traffic_today=$(vnstat --oneline -i <span class="hljs-variable">$INTERFACE</span> b | awk -F<span class="hljs-string">&#x27;;&#x27;</span> <span class="hljs-string">&#x27;&#123;print $6&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="awk-F’-’-print-6">awk -F’;’ '{print $6}</h4><p>这一部分是使用 <code>awk</code> 来处理 <code>vnstat</code> 输出，提取我们所关心的流量数据。</p><ul><li><strong><code>-F';'</code></strong>：<code>awk</code> 使用分号 (<code>;</code>) 作为字段分隔符（默认是空格或制表符），这里明确指定使用分号来分隔各个字段，因为 <code>vnstat --oneline</code> 的输出使用分号分隔。</li><li><strong><code>'&#123;print $6&#125;'</code></strong>：<code>awk</code> 输出第 6 列的值。字段从左到右编号，<code>$6</code> 表示第 6 列。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">traffic_today_value=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$traffic_today</span> | sed <span class="hljs-string">&#x27;s/ MiB//&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="sed-s-MiB">sed 's/ MiB//</h4><ul><li><p><code>sed</code> 是一个用于文本处理的命令行工具，通常用于搜索、替换、删除或编辑文本。</p><p>'s/ MiB//'是 sed的替换命令，解释如下：</p><ul><li><strong><code>s/</code></strong>：表示执行替换操作。</li><li><strong><code>MiB</code></strong>：这是我们要匹配的文本，即字符串 <code>MiB</code>，前面有一个空格。</li><li><strong><code>//</code></strong>：表示将匹配到的 <code>MiB</code> 替换为空，也就是删除 <code>MiB</code>。</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">traffic_month_gb=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;scale=2; <span class="hljs-variable">$traffic_month_value</span> / 1024&quot;</span> | bc)<br></code></pre></td></tr></table></figure><h4 id="echo-scale-2-traffic-month-value-1024">echo &quot;scale=2; $traffic_month_value / 1024</h4><ul><li>这是将字符串传递给 <code>bc</code> 进行计算。</li><li><strong><code>scale=2</code></strong>：这表示我们希望结果保留 2 位小数。<code>scale</code> 指定了小数点后应保留多少位精度。</li></ul><h4 id="cron任务"><code>cron</code>任务</h4><p><code>cron</code> 任务的格式用于设置定时任务，以指定的时间间隔自动运行特定的命令或脚本。<code>cron</code> 表达式的格式分为 <strong>5 个时间字段</strong>，以及要运行的命令或脚本。</p><h5 id="cron-格式"><code>cron</code> 格式</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">* * * * * /<span class="hljs-selector-tag">path</span>/<span class="hljs-selector-tag">to</span>/command<br></code></pre></td></tr></table></figure><h5 id="各字段的含义（从左到右依次）">各字段的含义（从左到右依次）</h5><ol><li><strong>分钟</strong>（0 - 59）：指定在每个小时的哪一分钟运行任务。</li><li><strong>小时</strong>（0 - 23）：指定在一天的哪个小时运行任务。</li><li><strong>日期</strong>（1 - 31）：指定在一个月的哪一天运行任务。</li><li><strong>月份</strong>（1 - 12）：指定在一年中的哪个月运行任务。</li><li><strong>星期几</strong>（0 - 7，0 和 7 都表示星期日）：指定在一周的哪一天运行任务。</li></ol><ul><li><strong>命令</strong>：在指定时间运行的命令或脚本。</li></ul><h5 id="cron-特殊符号"><code>cron</code> 特殊符号</h5><ul><li><strong><code>*</code></strong>：表示所有可能的值。例如，在&quot;分钟&quot;字段使用 <code>*</code> 表示每分钟都会执行任务。</li><li><strong><code>*/n</code></strong>：表示每隔 <code>n</code> 单位时间运行。例如，<code>*/5</code> 在&quot;分钟&quot;字段中表示每 5 分钟执行一次。</li><li><strong><code>,</code></strong>：表示多个值。例如，<code>1,15</code> 在&quot;分钟&quot;字段表示在每小时的第 1 分钟和第 15 分钟运行任务。</li><li><strong><code>-</code></strong>：表示一个范围。例如，<code>1-5</code> 在&quot;小时&quot;字段表示每天凌晨 1 点到 5 点执行任务。</li><li><strong><code>n-m/step</code></strong>：表示从 <code>n</code> 到 <code>m</code>，每 <code>step</code> 执行一次。例如，<code>0-59/15</code> 在&quot;分钟&quot;字段表示每 15 分钟执行一次。</li></ul><h5 id="示例：">示例：</h5><ol><li><p><strong>每 5 分钟运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">*/5 * * * * /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每 5 分钟运行一次命令 <code>/path/to/command</code>。</p></li><li><p><strong>每天凌晨 3 点运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 3 * * * /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每天凌晨 3:00 运行命令。</p></li><li><p><strong>每周一上午 7 点运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 7 * * 1 /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每周一上午 7:00 运行命令。</p></li><li><p><strong>每月 1 号的午夜运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 0 1 * * /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每月 1 号的 00:00 运行命令。</p></li><li><p><strong>每隔两天的午夜运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 0 */2 * * /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每隔两天的 00:00 运行命令。</p></li><li><p><strong>每周五下午 5 点运行一次</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 17 * * 5 /path/to/command<br></code></pre></td></tr></table></figure><p>解释：每周五下午 5:00 运行命令。</p></li></ol><h5 id="如何使用-cron-设置任务">如何使用 <code>cron</code> 设置任务</h5><ol><li><p><strong>编辑 <code>cron</code> 任务表</strong>：<br>运行以下命令进入 <code>crontab</code> 编辑器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab -e<br></code></pre></td></tr></table></figure></li><li><p><strong>添加 <code>cron</code> 表达式</strong>：<br>在 <code>crontab</code> 中输入你想要的定时任务。例如，设置每 5 分钟运行一次的任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">*/5 * * * * /path/to/command<br></code></pre></td></tr></table></figure></li><li><p><strong>保存并退出</strong>：<br>通常使用 <code>Ctrl + O</code> 保存，<code>Ctrl + X</code> 退出。</p></li><li><p><strong>查看已设置的 <code>cron</code> 任务</strong>：<br>你可以通过以下命令查看当前用户的 <code>cron</code> 任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab -l<br></code></pre></td></tr></table></figure></li></ol><h5 id="cron-特殊语法"><code>cron</code> 特殊语法</h5><p><code>cron</code> 还支持一些特殊的快捷语法，用于常见的时间间隔：</p><ul><li><code>@reboot</code>：在系统启动时运行。</li><li><code>@hourly</code>：每小时运行一次，相当于 <code>0 * * * *</code>。</li><li><code>@daily</code>：每天运行一次，相当于 <code>0 0 * * *</code>。</li><li><code>@weekly</code>：每周运行一次，相当于 <code>0 0 * * 0</code>。</li><li><code>@monthly</code>：每月运行一次，相当于 <code>0 0 1 * *</code>。</li><li><code>@yearly</code>：每年运行一次，相当于 <code>0 0 1 1 *</code>。</li></ul><h5 id="示例使用">示例使用</h5><p>假设你想每隔两天的午夜运行一个名为 <code>send_traffic.sh</code> 的脚本，可以在 <code>crontab</code> 中添加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 0 */2 * * /bin/bash ~/send_traffic.sh<br></code></pre></td></tr></table></figure><h3 id="总结">总结</h3><ul><li><strong><code>vnstat</code></strong> 监控网络流量，<code>telegram-send</code> 用于发送通知。</li><li>脚本每隔一天会自动运行，获取网络流量数据并发送给 Telegram 机器人。</li></ul><p>通过这些步骤，你的脚本将在每天自动发送已用流量的通知。</p>]]></content>
    
    
    <categories>
      
      <category>实用脚本</category>
      
    </categories>
    
    
    <tags>
      
      <tag>实用脚本</tag>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>b站自动倍速和字幕脚本</title>
    <link href="/2024/10/08/b%E7%AB%99%E8%87%AA%E5%8A%A8%E5%80%8D%E9%80%9F%E5%92%8C%E5%AD%97%E5%B9%95%E8%84%9A%E6%9C%AC/"/>
    <url>/2024/10/08/b%E7%AB%99%E8%87%AA%E5%8A%A8%E5%80%8D%E9%80%9F%E5%92%8C%E5%AD%97%E5%B9%95%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>b站倍速按钮最多只有两倍速，且一个视频集合不能默认开启字幕。其实都是小问题，那为什么作者要写一个脚本实现b站倍速和开启字幕，一是因为懒，二是因为闲的。</p></blockquote><h2 id="实现方法">实现方法</h2><p>字幕和倍速开启直接找到对应元素修改或点击即可，难点在于b站一个视频集合切换视频只是局部刷新，脚本不会重新运行，可以设置一个定时器定时执行脚本，但这种方法不够优雅，每个视频时长不固定。<br>解决方案是重写pushstate方法，切换视频会调用pushstate方法，因此重写该方法，让切换视频时重新执行一遍脚本即可。</p><h2 id="脚本">脚本</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ==UserScript==</span><br><span class="hljs-comment">// @name         b站三倍速并开启字幕</span><br><span class="hljs-comment">// @namespace    http://tampermonkey.net/</span><br><span class="hljs-comment">// @version      2024-10-08</span><br><span class="hljs-comment">// @description  try to take over the world!</span><br><span class="hljs-comment">// @author       You</span><br><span class="hljs-comment">// @match        https://www.bilibili.com/video/BV1eA411z7ET*</span><br><span class="hljs-comment">// @icon         https://www.google.com/s2/favicons?sz=64&amp;domain=bilibili.com</span><br><span class="hljs-comment">// @grant        none</span><br><span class="hljs-comment">// ==/UserScript==</span><br><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-string">&#x27;use strict&#x27;</span>;<br><br>    <span class="hljs-comment">// 保存当前的 URL，用于对比</span><br>    <span class="hljs-keyword">let</span> currentUrl = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-comment">// 创建一个函数，当 URL 改变时调用</span><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">onUrlChange</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-comment">// 检查 URL 是否真的改变了（避免不必要的操作）</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> !== currentUrl) &#123;<br>            currentUrl = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>; <span class="hljs-comment">// 更新当前 URL</span><br><br>            <span class="hljs-comment">// 延迟2秒确保新视频加载完成后执行逻辑</span><br>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-keyword">const</span> videoElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;video&#x27;</span>);<br>                <span class="hljs-keyword">if</span> (videoElement) &#123;<br>                    <span class="hljs-comment">// 设置播放速度为3倍</span><br>                    videoElement.<span class="hljs-property">playbackRate</span> = <span class="hljs-number">3</span>;<br>                &#125;<br><br>                <span class="hljs-comment">// 获取字幕显示区域和字幕按钮图标</span><br>                <span class="hljs-keyword">const</span> subtitleDisplay = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.bpx-player-subtitle-panel-text&#x27;</span>);<br>                <span class="hljs-keyword">const</span> subtitleIcon = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.bpx-player-ctrl-subtitle .bpx-player-ctrl-btn-icon span&#x27;</span>);<br><br>                <span class="hljs-comment">// 判断字幕是否开启</span><br>                <span class="hljs-keyword">if</span> (subtitleDisplay &amp;&amp; subtitleDisplay.<span class="hljs-property">innerText</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">&quot;&quot;</span>) &#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;字幕已开启&#x27;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;字幕未开启&#x27;</span>);<br>                    subtitleIcon.<span class="hljs-title function_">click</span>(); <span class="hljs-comment">// 点击开启字幕</span><br>                &#125;<br><br>            &#125;, <span class="hljs-number">2000</span>); <span class="hljs-comment">// 延迟2秒确保页面内容完全加载</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 监听 history.pushState 以捕捉到 URL 的变化</span><br>    (<span class="hljs-keyword">function</span>(<span class="hljs-params">history</span>) &#123;<br>        <span class="hljs-keyword">const</span> pushState = history.<span class="hljs-property">pushState</span>;<br>        history.<span class="hljs-property">pushState</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">state</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> history.<span class="hljs-property">onpushstate</span> === <span class="hljs-string">&quot;function&quot;</span>) &#123;<br>                history.<span class="hljs-title function_">onpushstate</span>(&#123; <span class="hljs-attr">state</span>: state &#125;);<br>            &#125;<br>            <span class="hljs-comment">// 原本的 pushState 方法</span><br>            <span class="hljs-keyword">const</span> ret = pushState.<span class="hljs-title function_">apply</span>(history, <span class="hljs-variable language_">arguments</span>);<br>            <span class="hljs-comment">// 检查 URL 是否改变</span><br>            <span class="hljs-title function_">onUrlChange</span>();<br>            <span class="hljs-keyword">return</span> ret;<br>        &#125;;<br>    &#125;)(<span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>);<br>    <span class="hljs-comment">// 监听 popstate 事件（例如用户点击浏览器的前进/后退按钮）</span><br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;popstate&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">onUrlChange</span>();<br>    &#125;);<br>    <span class="hljs-title function_">onUrlChange</span>();<br>&#125;)();<br><br></code></pre></td></tr></table></figure><h2 id="说明">说明</h2><p>推荐在油猴中使用此脚本，油猴会读取match的值来匹配哪些网站执行该脚本。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// @match        https://www.bilibili.com/video/BV1eA411z7ET*</span><br></code></pre></td></tr></table></figure><p>一般来说，一个视频集合的BV号都是一致的，所以在BV号后面加上*通配符即可匹配这个视频集合下的所有视频。</p><p>如果在video后面加上*，就会匹配b站所有视频。</p><p>调整倍速只需要调整这里的数值：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">videoElement.<span class="hljs-property">playbackRate</span> = <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>实用脚本</category>
      
    </categories>
    
    
    <tags>
      
      <tag>实用脚本</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>神经网络中的反向传播（backwards）</title>
    <link href="/2024/10/07/backwards/"/>
    <url>/2024/10/07/backwards/</url>
    
    <content type="html"><![CDATA[<h1>1.什么是反向传播</h1><blockquote><p>反向传播是一种用于高效计算梯度的方法，它结合了链式法则在神经网络中的应用。反向传播的主要作用是将损失函数的误差从输出层逐层向前传播到输入层，以便计算出每一层参数的梯度。</p></blockquote><p>简单来说，反向传播就是计算机计算梯度的方法。</p><h1>2.计算步骤</h1><img src="/2024/10/07/backwards/forward.png" class="" title="forward"><p>假设有这样一个简单的神经网络，我们的目标是求出cost函数关于各参数的梯度，也就是：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mi>L</mi></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mrow><mi>L</mi><mo>−</mo><mn>2</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mi>L</mi></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mrow><mi>L</mi><mo>−</mo><mn>2</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>2</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial w^L},\frac{\partial C}{\partial w^{L-1}},\frac{\partial C}{\partial w^{L-2}},\frac{\partial C}{\partial b^L} ,\frac{\partial C}{\partial b^{L-1}} ,\frac{\partial C}{\partial b^{L-2}} ,\frac{\partial C}{\partial a^{L-1}} ,\frac{\partial C}{\partial a^{L-2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>我们有：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi>z</mi><mi>L</mi></msup><mo>=</mo><msup><mi>w</mi><mi>L</mi></msup><mo>⋅</mo><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><msup><mi>b</mi><mi>L</mi></msup><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msup><mi>a</mi><mi>L</mi></msup><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><msup><mi>z</mi><mi>L</mi></msup><mo stretchy="false">)</mo><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>C</mi><mo>=</mo><mo stretchy="false">(</mo><msup><mi>a</mi><mi>L</mi></msup><mo>−</mo><mi>y</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}z^L = w^L \cdot a^{L-1}+b^L\quad(2-1)\\ \\[1em] a^L = \sigma(z^L)\quad(2-2)\\ \\[1em] C = (a^L-y)^2\quad(2-3)\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.654em;vertical-align:-4.577em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.077em;"><span style="top:-7.1857em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-5.6857em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-3.1343em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span><span style="top:-1.6343em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:0.917em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.577em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>根据链式法则,我们有：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mi>L</mi></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mi>L</mi></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>4</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mi>L</mi></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mi>L</mi></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>5</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mi>L</mi></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>6</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}\frac{\partial C}{\partial w^L} = \frac{\partial z^L}{\partial w^L}\frac{\partial a^L}{\partial z^L}\frac{\partial C}{\partial a^L}\quad(2-4)\\ \\[1em] \frac{\partial C}{\partial b^L} = \frac{\partial z^L}{\partial b^L}\frac{\partial a^L}{\partial z^L}\frac{\partial C}{\partial a^L}\quad(2-5)\\ \\[1em] \frac{\partial C}{\partial a^{L-1}} = \frac{\partial z^L}{\partial a^{L-1}}\frac{\partial a^L}{\partial z^L}\frac{\partial C}{\partial a^L}\quad(2-6)\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:12.513em;vertical-align:-6.0065em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.5065em;"><span style="top:-8.5065em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">4</span><span class="mclose">)</span></span></span><span style="top:-6.6805em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"></span></span><span style="top:-3.5022em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">5</span><span class="mclose">)</span></span></span><span style="top:-1.6762em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"></span></span><span style="top:1.5022em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">6</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.0065em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>4、5、6式子的第一项计算出来分别是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">a^{L-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> 、 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>w</mi><mi>L</mi></msup></mrow><annotation encoding="application/x-tex">w^L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span> ，第二项都是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><msup><mi>z</mi><mi>L</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma&#x27;(z^L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，第三项都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial a^L}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.232em;vertical-align:-0.3519em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.6481em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7741em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3519em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，也就是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><msub><mi>a</mi><mi>L</mi></msub><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2(a_L-y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>。</p><p>我们再计算L-1层，同样根据链式法则，我们有：</p><p class="katex-block "><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>w</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>7</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>b</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>8</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>2</mn></mrow></msup></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac><mspace width="1em"/><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>9</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}\frac{\partial C}{\partial w^{L-1}} = \frac{\partial z^{L-1}}{\partial w^{L-1}}\frac{\partial a^{L-1}}{\partial z^{L-1}}\frac{\partial C}{\partial a^{L-1}}\quad(2-7)\\ \\[1em] \frac{\partial C}{\partial b^{L-1}} = \frac{\partial z^{L-1}}{\partial b^{L-1}}\frac{\partial a^{L-1}}{\partial z^{L-1}}\frac{\partial C}{\partial a^{L-1}}\quad(2-8)\\ \\[1em] \frac{\partial C}{\partial a^{L-2}} = \frac{\partial z^{L-1}}{\partial a^{L-1}}\frac{\partial a^{L-1}}{\partial z^{L-1}}\frac{\partial C}{\partial a^{L-1}}\quad(2-9)\\\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:12.513em;vertical-align:-6.0065em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.5065em;"><span style="top:-8.5065em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">7</span><span class="mclose">)</span></span></span><span style="top:-6.6805em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"></span></span><span style="top:-3.5022em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">8</span><span class="mclose">)</span></span></span><span style="top:-1.6762em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"></span></span><span style="top:1.5022em;"><span class="pstrut" style="height:3.5183em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7673em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">9</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.0065em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>7、8、9式子的第一项计算出来分别是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>2</mn></mrow></msup></mrow><annotation encoding="application/x-tex">a^{L-2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>w</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">w^{L-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> ，第二项都是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><msup><mi>z</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma&#x27;(z^{L-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ，第三项都是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial a^{L-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.232em;vertical-align:-0.3519em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.6481em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7741em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3519em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 。</p><p>不难看出，我们知道<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mi>L</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial a^L}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.232em;vertical-align:-0.3519em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.6481em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7741em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">L</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3519em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>  ，就可以算出cost函数对L层各参数的偏导，而6式计算出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial a^{L-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.232em;vertical-align:-0.3519em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.6481em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7741em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3519em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> ，利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>C</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mi>a</mi><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial C}{\partial a^{L-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.232em;vertical-align:-0.3519em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.6481em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7741em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3519em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 又可以计算出cost函数对L-1层各参数的偏导，如此反向传播，计算出cost函数对所有参数的偏导数。</p>]]></content>
    
    
    <categories>
      
      <category>神经网络</category>
      
    </categories>
    
    
    <tags>
      
      <tag>神经网络</tag>
      
      <tag>反向传播</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/10/06/hello-world/"/>
    <url>/2024/10/06/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start">Quick Start</h2><h3 id="Create-a-new-post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
